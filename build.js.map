{"version":3,"file":"build.js","sources":["src/utils.js","src/config.js","src/main.js"],"sourcesContent":["// utility methods for EventSky\n\nexport default {\n\t/**\n\t * This provides a format for event map objects\n\t * @returns {{}}\n\t */\n\tcreateNewEventMap () {\n\t\treturn {\n\t\t\t// aggregate number of handlers for this event\n\t\t\thandlers: 0,\n\t\t\t_handlers: 0,\n\t\t\ton: {},\n\t\t\tonce: {},\n\t\t\tbeforeAll: {},\n\t\t\tafterAll: {},\n\t\t}\n\t},\n}\n","export default {\n\t/**\n\t * This method sets the events that are expected to happen in the store.\n\t * If this method is invoked, it automatically assumes the intention to\n\t * restrict to only expected events that are set explicitly.\n\t * @param events [string|array]\n\t */\n\tsetExpectedEvents (events) {\n\t\t// check if there are existing events and config.restrictToExpected is false - show warning/log\n\t\t// because it means they first assigned events then set restrictToExpected\n\n\t\tthis.config.restrictToExpected = true\n\n\t\t// todo: set this.events = {}\n\n\t\treturn this\n\t}\n}","// todo: add changelog before publish\n// todo: verify a correct singleton pattern\n// todo: in the case of React, we need to ensure handlers are removed if they don't exist, ie: cdunm\n// todo: look into cancellable handlers?\n// todo: write readme on how restrictToExpected helps predictability in teams and large apps, guide on file architecture\n\nimport utils from './utils'\nimport config from './config'\n\nclass EventSky {\n\tconstructor () {\n\t\tthis.config = {\n\t\t\trestrictToExpected: false,\n\t\t\tfirehose: false,\n\t\t}\n\n\t\tthis._config = config\n\t\tthis._utils = utils\n\t\t// map of events\n\t\tthis.events = {}\n\t\tthis._firehose = msg => this.config.firehose ? console.log(`EventSky Firehose >> ${msg}`) : null\n\n\t\t// util to setup 'when' event handlers\n\t\tconst _addEventHandler = (when) => {\n\t\t\treturn (event, handler) => {\n\t\t\t\t// verify params\n\t\t\tif (typeof event !== 'string' || event.length < 1 || typeof handler !== 'function') {\n\t\t\t\t\tconsole.warn(`EventSky warning: \"${event}\" event must be a string and handler must be a function - not set with .${when} handler`)\n\n\t\t\t\t\treturn this\n\t\t\t\t}\n\n\t\t\t\t// first check if we're restricting to expected only\n\t\t\t\tif (this.config.restrictToExpected) {\n\t\t\t\t\tif (!Object.keys(this.events).includes(event)) {\n\t\t\t\t\t\tthis._firehose(`\"${event}\" handler cannot be set because it is not an expected event \"restrictToExpected = true\"`)\n\n\t\t\t\t\t\treturn this\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// ensure the event exists and is setup on the event store\n\t\t\t\tif (!this.events[event]) {\n\t\t\t\t\tthis.events[event] = this._utils.createNewEventMap()\n\t\t\t\t}\n\n\t\t\t\tthis.events[event].handlers++\n\t\t\t\tconst _handlerCount = this.events[event]._handlers++\n\t\t\t\tconst eventId = `${event}.${when}.${_handlerCount}`\n\t\t\t\tthis.events[event][when][eventId] = handler\n\n\t\t\t\treturn eventId\n\t\t\t}\n\t\t}\n\t\t// setup 'when' event handlers\n\t\tthis.on = _addEventHandler('on')\n\t\tthis.once = _addEventHandler('once')\n\t\tthis.beforeAll = _addEventHandler('beforeAll')\n\t\tthis.afterAll = _addEventHandler('afterAll')\n\t}\n\n\t/**\n\t * Remove a handler for an event, the first parameter can be and event name\n\t * or an eventId to be removed.\n\t * @param eventOrId\n\t * @param handler\n\t * @returns {EventSky}\n\t */\n\toff (eventOrId, handler) {\n\t\tObject.keys(this.events).forEach(eventName => {\n\t\t\t// iterate each 'when' event lifecycle and look for eventId or handler to remove\n\t\t\tObject.keys(this.events[eventName]).forEach(eventWhen => {\n\t\t\t\tif (!['beforeAll', 'on', 'once', 'afterAll'].includes(eventWhen)) return\n\t\t\t\t// iterate each event of the current 'when' for event\n\t\t\t\tObject.keys(this.events[eventName][eventWhen]).forEach(eventId => {\n\t\t\t\t\tconst del = (!handler && eventId === eventOrId) || (this.events[eventName][eventWhen][eventId] === handler)\n\n\t\t\t\t\tif (del) {\n\t\t\t\t\t\tdelete this.events[eventName][eventWhen][eventId]\n\t\t\t\t\t\tthis.events[eventName].handlers--\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t})\n\n\t\treturn this\n\t}\n\n\ttrigger (event, data) {\n\t\tif (this.config.restrictToExpected) {\n\t\t\tif (!Object.keys(this.events).includes(event)) {\n\t\t\t\tthis._firehose(`\"${event}\" triggered and is not an expected event \"restrictToExpected = true\"`)\n\n\t\t\t\treturn this\n\t\t\t}\n\t\t} else if (!this.events[event]) {\n\t\t\tthis._firehose(`\"${event}\" triggered with no handlers setup`)\n\n\t\t\treturn this\n\t\t}\n\n\t\tthis._firehose(`\"${event}\" triggered`)\n\n\t\t// beforeAll\n\t\tconst beforeAll = this.events[event].beforeAll\n\t\ttry {\n\t\t\tObject.keys(beforeAll).forEach(key => beforeAll[key](data))\n\t\t} catch (e) {\n\t\t\tconsole.error(`EventSky error: ${event} beforeAll handler errored`, { error: e, data: data })\n\t\t}\n\n\t\t// on\n\t\tconst on = this.events[event].on\n\t\ttry {\n\t\t\tObject.keys(on).forEach(key => on[key](data))\n\t\t} catch (e) {\n\t\t\tconsole.error(`EventSky error: ${event} on handler errored`, { error: e, data: data })\n\t\t}\n\n\t\t// once\n\t\tconst once = this.events[event].once\n\t\ttry {\n\t\t\tObject.keys(once).forEach(key => {\n\t\t\t\tonce[key](data)\n\t\t\t\t// remove handler\n\t\t\t\tthis.off(event, once[key](data))\n\t\t\t})\n\t\t} catch (e) {\n\t\t\tconsole.error(`EventSky error: ${event} once handler errored`, { error: e, data: data })\n\t\t}\n\n\t\t// afterAll\n\t\tconst afterAll = this.events[event].afterAll\n\t\ttry {\n\t\t\tObject.keys(afterAll).forEach(key => afterAll[key](data))\n\t\t} catch (e) {\n\t\t\tconsole.error(`EventSky error: ${event} afterAll handler errored`, { error: e, data: data })\n\t\t}\n\n\t\treturn this\n\t}\n}\n\nexport default new EventSky()\n"],"names":["events","config","restrictToExpected","EventSky","_config","_utils","utils","_firehose","firehose","console","log","msg","_addEventHandler","when","event","handler","length","warn","Object","keys","includes","createNewEventMap","handlers","_handlerCount","_handlers","eventId","on","once","beforeAll","afterAll","eventOrId","forEach","eventName","eventWhen","del","data","key","e","error","off"],"mappings":"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"}